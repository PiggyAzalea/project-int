<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPython Notebook Preview with Floating Window</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
    <style>
        /* Styling for the floating window */
        .floating-window {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 300px;
            height: 400px;
            background-color: #fff;
            border: 1px solid #ccc;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Styling for the window header */
        .window-header {
            background-color: #f0f0f0;
            padding: 5px;
            cursor: move;
        }

        /* Styling for the window content */
        .window-content {
            padding: 10px;
            height: calc(100% - 30px);
            overflow: auto;
        }

        /* Styling for the Python console */
        .python-console textarea {
            width: 100%;
            height: 80px;
        }

        .python-console .output {
            width: 100%;
            height: calc(100% - 110px);
            overflow-y: auto;
            background-color: #f8f8f8;
            border-top: 1px solid #ccc;
            padding: 5px;
        }
    </style>
</head>
<body>
    <!-- IPython Notebook Preview -->
    <pre>{{ content }}</pre>

    <!-- Floating window for Python console -->
    <div class="floating-window" id="floatingWindow">
        <div class="window-header" id="windowHeader">Python Console</div>
        <div class="window-content python-console">
            <textarea id="pythonInput" placeholder="Enter Python code here..."></textarea>
            <button onclick="runPythonCode()">Run</button>
            <div class="output" id="pythonOutput"></div>
        </div>
    </div>

    <!-- JavaScript for making the window draggable -->
    <script>
        function dragElement(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            if (elmnt.querySelector(".window-header")) {
                elmnt.querySelector(".window-header").onmousedown = dragMouseDown;
            } else {
                elmnt.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        dragElement(document.getElementById("floatingWindow"));

        // Initialize Pyodide
        async function loadPyodideAndPackages() {
            const pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.21.3/full/"
            });
            return pyodide;
        }

        let pyodideReadyPromise = loadPyodideAndPackages();

        // Function to run Python code using Pyodide
        async function runPythonCode() {
            const input = document.getElementById("pythonInput").value;
            const output = document.getElementById("pythonOutput");
            output.innerHTML = '';  // Clear previous output

            try {
                const pyodide = await pyodideReadyPromise;
                const result = await pyodide.runPythonAsync(input);
                output.innerHTML = `<pre>${result}</pre>`;
            } catch (e) {
                output.innerHTML = `<pre style="color: red;">${e}</pre>`;
            }
        }

        // Debugging: Check if Pyodide is ready
        pyodideReadyPromise.then(() => {
            console.log("Pyodide is ready");
        }).catch((error) => {
            console.error("Error loading Pyodide:", error);
        });
    </script>
</body>
</html>
